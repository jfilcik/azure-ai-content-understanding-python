# ====================================================================
# Azure AI Content Understanding - API Testing Guide
# ====================================================================
#
# This file demonstrates how to use Azure AI Content Understanding APIs
# to analyze documents, images, videos, and audio using prebuilt and 
# custom analyzers.
#
# ⚠️ SETUP REQUIRED - BEFORE RUNNING ANY REQUESTS:
# 
# 1. Edit the .env file in this same directory (tools/BugBashSample/.env)
# 2. Set your API_KEY and ENDPOINT_URL values:
#    API_KEY="your-subscription-key-here"
#    ENDPOINT_URL="https://your-resource.services.ai.azure.com"
# 3. Save the .env file
# 4. Run any request using the "Send Request" link above each HTTP request
#
# Variables will be automatically loaded from .env - do not edit this file.
#
# DOCUMENTATION:
# - Models & Deployments: https://review.learn.microsoft.com/en-us/azure/ai-services/content-understanding/concepts/models-deployments?branch=main
# - Migration Guide (Preview to GA): https://review.learn.microsoft.com/en-us/azure/ai-services/content-understanding/how-to/migration-preview-to-ga
# - Analyzer Reference: https://learn.microsoft.com/en-us/azure/ai-services/content-understanding/concepts/analyzer-reference
#
# ====================================================================

# Variables - Automatically loaded from .env file in the same directory
@subscriptionKey = {{$dotenv API_KEY}}
@endpoint = {{$dotenv ENDPOINT_URL}}
@apiVersion = 2025-11-01

# ====================================================================
# SECTION 1: CONFIGURE DEFAULT MODEL DEPLOYMENTS (BYOC)
# ====================================================================
# 
# Configure default model deployments for your resource. This allows you to
# use custom Azure OpenAI deployments (Bring Your Own Compute) instead of 
# the default shared models.
#
# Learn more: https://review.learn.microsoft.com/en-us/azure/ai-services/content-understanding/concepts/models-deployments?branch=main
#

### Set default model deployments for the resource
# This configures which model deployments to use by default for completion and embedding tasks
# Alternatively, if you setup a resource using https://aka.ms/cu-studio then you can skip this step
PATCH {{endpoint}}/contentunderstanding/defaults?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}
Content-Type: application/json

{
  "modelDeployments": {
    "gpt-4.1": "gpt-4.1-datazone",
    "gpt-4.1-mini": "gpt-4.1-mini",
    "text-embedding-ada-002": "text-embedding-ada-002"
  }
}

### Get current default settings
GET {{endpoint}}/contentunderstanding/defaults?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

# ====================================================================
# SECTION 2: LIST AND EXPLORE ANALYZERS
# ====================================================================
#
# Analyzers are the core components that process your content. Azure provides
# prebuilt analyzers for common scenarios and you can create custom analyzers.
#
# Prebuilt analyzers include:
# - prebuilt-document: Extract text, tables, and structure from documents
# - prebuilt-invoice: Extract invoice-specific fields
# - prebuilt-video: Analyze video content with scene detection and transcription
# - prebuilt-audio: Transcribe and analyze audio content
# - prebuilt-imageSearch: Analyze and search within images
#
# Learn more: https://learn.microsoft.com/en-us/azure/ai-services/content-understanding/concepts/analyzer-reference
#

### List all available analyzers
GET {{endpoint}}/contentunderstanding/analyzers?api-version={{apiVersion}}
Content-Type: application/json
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

### Get details of a specific analyzer
GET {{endpoint}}/contentunderstanding/analyzers/prebuilt-invoice?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

# ====================================================================
# SECTION 3: TEST PREBUILT ANALYZERS
# ====================================================================
#
# Test the prebuilt analyzers with sample documents to understand their
# capabilities before creating custom analyzers.
#

### 3.1 Analyze a document with prebuilt-document analyzer
# This analyzer extracts text, tables, key-value pairs, and document structure
# @name documentAnalysis
POST {{endpoint}}/contentunderstanding/analyzers/prebuilt-document:analyze?api-version={{apiVersion}}
Content-Type: application/json
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

{
  "inputs": [
    {
      "url": "https://github.com/Azure-Samples/azure-ai-content-understanding-python/raw/refs/heads/main/data/invoice.pdf"
    }
  ],
  "modelDeployments": {
    "gpt-4.1": "gpt-4.1-datazone"
  }
}

### Get document analysis results (uses operation ID from previous request)
GET {{endpoint}}/contentunderstanding/analyzerResults/{{documentAnalysis.response.body.id}}?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

### 3.2 Analyze an invoice with prebuilt-invoice analyzer
# Specialized analyzer for invoices that extracts vendor, items, totals, etc.
# @name invoiceAnalysis
POST {{endpoint}}/contentunderstanding/analyzers/prebuilt-invoice:analyze?api-version={{apiVersion}}
Content-Type: application/json
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

{
  "inputs": [
    {
      "url": "https://github.com/Azure-Samples/azure-ai-content-understanding-python/raw/refs/heads/main/data/invoice.pdf"
    }
  ]
}

### Get invoice analysis results (uses operation ID from previous request)
GET {{endpoint}}/contentunderstanding/analyzerResults/{{invoiceAnalysis.response.body.id}}?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

### 3.3 Analyze an image with prebuilt-imageSearch analyzer
# Extract visual content, text, and enable semantic search within images
# @name imageAnalysis
POST {{endpoint}}/contentunderstanding/analyzers/prebuilt-imageSearch:analyze?api-version={{apiVersion}}
Content-Type: application/json
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

{
  "inputs": [
    {
      "url": "https://github.com/Azure-Samples/azure-ai-content-understanding-python/raw/refs/heads/main/data/pieChart.jpg"
    }
  ],
  "modelDeployments": {
    "gpt-4.1": "gpt-4.1-datazone",
    "text-embedding-3-large": "text-embedding-3-large"
  }
}

### Get image analysis results (uses operation ID from previous request)
GET {{endpoint}}/contentunderstanding/analyzerResults/{{imageAnalysis.response.body.id}}?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

# ====================================================================
# SECTION 4: CREATE CUSTOM DOCUMENT ANALYZER
# ====================================================================
#
# Create custom analyzers to extract specific fields from your documents.
# Custom analyzers build on top of prebuilt analyzers and add field schemas
# to define what information to extract.
#
# Learn more: https://review.learn.microsoft.com/en-us/azure/ai-services/content-understanding/how-to/migration-preview-to-ga
#

### 4.1 Create a custom insurance claim form analyzer
# This analyzer extracts specific fields from insurance claim forms
PUT {{endpoint}}/contentunderstanding/analyzers/claimForm?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}
Content-Type: application/json

{
  "baseAnalyzerId": "prebuilt-document",
  "analyzerId": "claimForm",
  "models": {
    "completion": "gpt-4.1",
    "embedding": "text-embedding-ada-002"
  },
  "fieldSchema": {
    "fields": {
      "PolicyNumber": {
        "type": "string",
        "method": "extract",
        "description": "The insurance policy number associated with this claim."
      },
      "ClaimNumber": {
        "type": "string",
        "method": "extract",
        "description": "The unique claim number assigned to this claim."
      },
      "TotalClaimAmount": {
        "type": "number",
        "method": "extract",
        "description": "The total amount being claimed."
      },
      "AccidentDate": {
        "type": "string",
        "method": "extract",
        "description": "The date when the accident occurred."
      },
      "LossType": {
        "type": "string",
        "method": "classify",
        "description": "The type of loss (e.g., collision, theft, fire).",
        "enum": ["collision", "theft", "fire", "natural disaster", "vandalism"]
      }
    },
    "definitions": {}
  },
  "omitContent": true
}

### Get the custom analyzer details
GET {{endpoint}}/contentunderstanding/analyzers/claimForm?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

### 4.2 Create a custom invoice analyzer
# Example of a custom invoice analyzer with specific field extraction
PUT {{endpoint}}/contentunderstanding/analyzers/invoice_custom?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}
Content-Type: application/json

{
  "analyzerId": "invoice_custom",
  "baseAnalyzerId": "prebuilt-document",
  "description": "Custom invoice analyzer with specific fields",
  "scenario": "document",
  "models": {
    "completion": "gpt-4.1"
  },
  "fieldSchema": {
    "fields": {
      "VendorName": {
        "type": "string",
        "method": "extract",
        "description": "Vendor issuing the invoice"
      },
      "Items": {
        "type": "array",
        "method": "extract",
        "items": {
          "type": "object",
          "properties": {
            "Description": {
              "type": "string",
              "method": "extract",
              "description": "Description of the item"
            },
            "Amount": {
              "type": "number",
              "method": "extract",
              "description": "Amount of the item"
            }
          }
        }
      }
    }
  }
}

### Test the custom invoice analyzer
# @name customInvoiceAnalysis
POST {{endpoint}}/contentunderstanding/analyzers/invoice_custom:analyze?api-version={{apiVersion}}
Content-Type: application/json
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

{
  "inputs": [
    {
      "url": "https://documentintelligence.ai.azure.com/documents/samples/read/read-healthcare.png"
    }
  ],
  "modelDeployments": {
    "gpt-4.1": "gpt-4.1-datazone"
  }
}

### Get custom invoice results (uses operation ID from previous request)
GET {{endpoint}}/contentunderstanding/analyzerResults/{{customInvoiceAnalysis.response.body.id}}?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

### 4.3 Create a complex multi-document analyzer with content categories
# This analyzer can classify and route different document types to specialized analyzers
PUT {{endpoint}}/contentunderstanding/analyzers/insuranceClaim?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}
Content-Type: application/json

{
  "baseAnalyzerId": "prebuilt-document",
  "analyzerId": "insuranceClaim",
  "models": {
    "completion": "gpt-4.1",
    "embedding": "text-embedding-ada-002"
  },
  "config": {
    // Enable splitting of the input into segments for multi-document files
    "enableSegment": true,
    "contentCategories": {
      "claimForm": {
        "description": "The claim form for Zava Insurance",
        "analyzerId": "claimForm"
      },
      "estimate": {
        "description": "The body shop estimate or contractor estimate to fix the property damage.",
        "analyzerId": "prebuilt-invoice"
      },
      "medicalReport": {
        "description": "A doctors assessment or medical report related to injury suffered.",
        "analyzerId": "prebuilt-document"
      },
      "policeReport": {
        "description": "A police or law enforcement report detailing the events that lead to the loss."
      }
    },
    "omitContent": true
  }
}

### Delete an analyzer (if needed)
DELETE {{endpoint}}/contentunderstanding/analyzers/insuranceClaim?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

# ====================================================================
# SECTION 5: VIDEO ANALYZER EXAMPLES
# ====================================================================
#
# Video analyzers can transcribe, detect scenes, extract entities, and 
# perform custom analysis on video content.
#
# Learn more: https://learn.microsoft.com/en-us/azure/ai-services/content-understanding/concepts/analyzer-reference
#

### 5.1 Test prebuilt video analyzer
# @name videoAnalysis
POST {{endpoint}}/contentunderstanding/analyzers/prebuilt-video:analyze?api-version={{apiVersion}}
Content-Type: application/json
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

{
  "inputs": [
    {
      "url": "https://github.com/Azure-Samples/azure-ai-content-understanding-python/raw/refs/heads/main/data/FlightSimulator.mp4"
    }
  ],
  "modelDeployments": {
    "gpt-4.1": "gpt-4.1-datazone",
    "text-embedding-3-large": "text-embedding-3-large"
  }
}

### Get video analysis results (uses operation ID from previous request)
GET {{endpoint}}/contentunderstanding/analyzerResults/{{videoAnalysis.response.body.id}}?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

### 5.2 Create custom video analyzer with dynamic chaptering
# This analyzer segments videos into chapters/stories with scene detection
PUT {{endpoint}}/contentunderstanding/analyzers/video_chaptering?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}
Content-Type: application/json

{
  "description": "Dynamic video chaptering with scene detection",
  "scenario": "videoShot",
  "baseAnalyzerId": "prebuilt-video",
  "models": {
    "completion": "gpt-4.1"
  },
  "config": {
    "returnDetails": true,
    "enableSegmentation": true,
    "segmentationMode": "custom",
    "segmentationDefinition": "Segment the video into stories or chapters. A story (chapter) in a video is a self-contained portion of the program dedicated to a specific news story, topic, or theme. Each segment typically includes a distinct introduction, development, and (sometimes) a conclusion, and can feature a combination of elements such as reporter narration, interviews, sound bites, relevant footage (B-roll), and graphics.",
    "locales": ["en-US"]
  },
  "fieldSchema": {
    "name": "Content Understanding - Dynamic Chaptering",
    "fields": {
      "Segments": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "SegmentId": {
              "type": "string"
            },
            "SegmentType": {
              "type": "string",
              "method": "generate",
              "description": "The short title or a short summary of the story or chapter."
            },
            "Scenes": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "Description": {
                    "type": "string",
                    "method": "generate",
                    "description": "A five-word description of the scene. A scene is a smaller segment of the segment where a continous block for storytelling unfolds within a specific time, place, and set of characters. A scene can only belong to a single chapter, and cannot overlap with other scenes. Scenes are sequential across the video."
                  },
                  "StartTimestamp": {
                    "type": "string",
                    "description": "the start timestamp of the scene"
                  },
                  "EndTimestamp": {
                    "type": "string",
                    "description": "the end timestamp of the scene"
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}

### Get the video analyzer details
GET {{endpoint}}/contentunderstanding/analyzers/video_chaptering?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

### Test the custom video chaptering analyzer
# @name videoChapteringAnalysis
POST {{endpoint}}/contentunderstanding/analyzers/video_chaptering:analyze?api-version={{apiVersion}}
Content-Type: application/json
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

{
  "inputs": [
    {
      "url": "https://github.com/Azure-Samples/azure-ai-content-understanding-python/blob/402ec1bf337d54b438581c69dbfb784da74ded38/data/video.mp4"
    }
  ]
}

### Get video chaptering results (uses operation ID from previous request)
GET {{endpoint}}/contentunderstanding/analyzerResults/{{videoChapteringAnalysis.response.body.id}}?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

# ====================================================================
# SECTION 6: AUDIO ANALYZER EXAMPLES
# ====================================================================
#
# Audio analyzers can transcribe speech, detect speakers, and extract
# insights from audio content.
#

### Test prebuilt audio analyzer (coming soon - placeholder)
# POST {{endpoint}}/contentunderstanding/analyzers/prebuilt-audio:analyze?api-version={{apiVersion}}
# Content-Type: application/json
# Ocp-Apim-Subscription-Key: {{subscriptionKey}}
#
# {
#   "inputs": [
#     {
#       "url": "https://example.com/audio-sample.mp3"
#     }
#   ]
# }

# ====================================================================
# SECTION 7: ANALYZER MANAGEMENT OPERATIONS
# ====================================================================
#
# Copy analyzers between resources or regions for deployment purposes.
#

### Copy analyzer within same resource
POST {{endpoint}}/contentunderstanding/analyzers/insuranceClaimv3:copy?api-version={{apiVersion}}
Content-Type: application/json
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

{
  "sourceAnalyzerId": "insuranceClaim"
}

### Grant copy authorization for cross-resource copy
POST {{endpoint}}/contentunderstanding/analyzers/insuranceClaim:grantCopyAuthorization?api-version={{apiVersion}}
Content-Type: application/json
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

{
  "targetAzureResourceId": "/subscriptions/3b393ccb-47e3-4dea-9004-0c1085b5aba6/resourceGroups/mmi-sea-eft/providers/Microsoft.CognitiveServices/accounts/foundry-sea-eft",
  "targetRegion": "southeastasia"
}

### Copy analyzer to different resource (use authorization from above)
# POST https://foundry-sea-eft.cognitiveservices.azure.com/contentunderstanding/analyzers/insuranceClaimCopy:copy?api-version={{apiVersion}}
# Content-Type: application/json
# Ocp-Apim-Subscription-Key: {{targetSubscriptionKey}}
#
# {
#   "targetAzureResourceId": "/subscriptions/3b393ccb-47e3-4dea-9004-0c1085b5aba6/resourceGroups/mmi-sea-eft/providers/Microsoft.CognitiveServices/accounts/foundry-sea-eft",
#   "targetRegion": "southeastasia",
#   "expiresAt": "2025-11-01T19:18:11.095328+00:00"
# }

# ====================================================================
# END OF GUIDE
# ====================================================================


# Test Create a DataSnipper Repro



### 4.1 Create a custom insurance claim form analyzer
# This analyzer extracts specific fields from insurance claim forms
PUT {{endpoint}}/contentunderstanding/analyzers/dsTest?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}
Content-Type: application/json

{
  "baseAnalyzerId": "prebuilt-document",
  "analyzerId": "dsTest",
  "models": {
    "completion": "gpt-4o",
    "embedding": "text-embedding-ada-002"
  },
  "fieldSchema": {
    "fields": {
      "employees": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "employee_name": {
              "type": "string",
              "method": "extract",
              "description": "The name of the employee",
              "estimateSourceAndConfidence": true
            }
          },
          "description": "The employee of the company"
        },
        "description": "The employees of the company"
      }
    }
  }
}

### Get the custom analyzer details
GET {{endpoint}}/contentunderstanding/analyzers/dsTest?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}



### Test dsTest analyzer with document
# @name dsTestAnalysis
POST {{endpoint}}/contentunderstanding/analyzers/dsTest:analyze?api-version={{apiVersion}}
Content-Type: application/json
Ocp-Apim-Subscription-Key: {{subscriptionKey}}

{
  "inputs": [
    {
      "url": "https://mmiusw3bbstore.blob.core.windows.net/bugbash-20251020/jfilcik/ADP%20Journals.pdf?sv=2025-07-05&spr=https&st=2025-12-15T17%3A06%3A24Z&se=2025-12-16T17%3A06%3A24Z&skoid=e48ae032-21b6-418b-963c-3129b6a130d3&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2025-12-15T17%3A06%3A24Z&ske=2025-12-16T17%3A06%3A24Z&sks=b&skv=2025-07-05&sr=b&sp=r&sig=fX9biRmkc2IPA8BGUrgyZZ651BnB0WPiU54YIyplE2Q%3D"
    }
  ]
}

### Get dsTest analysis results (uses operation ID from previous request)
GET {{endpoint}}/contentunderstanding/analyzerResults/{{dsTestAnalysis.response.body.id}}?api-version={{apiVersion}}
Ocp-Apim-Subscription-Key: {{subscriptionKey}}